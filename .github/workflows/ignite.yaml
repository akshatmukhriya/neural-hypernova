name: ðŸš€ Ignite Neural Supernova
on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Environment (local/aws)'
        required: true
        default: 'local'

jobs:
  deploy:
    # Use 'self-hosted' for Local Demo, 'ubuntu-latest' for AWS
    runs-on: ${{ inputs.target == 'local' && 'self-hosted' || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v3

      # 1. INFRASTRUCTURE (Terraform)
      - name: ðŸ—ï¸ Provision Infrastructure
        run: |
          cd infra
          terraform init
          terraform apply -var="target=${{ inputs.target }}" -auto-approve

      # 2. CONFIGURATION (Ansible)
      # Terraform generated the inventory file in the previous step
      - name: Bootstrap ClusterðŸ (Setup & Run Ansible)
        run: |
          echo ">> [DEPENDENCY] Installing Ansible & Python K8s lib..."
          # We install Ansible and the Kubernetes Python library (required for the module)
          pip3 install ansible kubernetes
          
          echo ">> [GALAXY] Installing K8s Collection..."
          # Ensure path includes user base binary directory just in case
          export PATH=$PATH:$(python3 -m site --user-base)/bin
          ansible-galaxy collection install kubernetes.core
          
          echo ">> [EXECUTION] Running Playbook..."
          cd config
          ansible-playbook -i ../infra/inventory.ini playbook.yaml