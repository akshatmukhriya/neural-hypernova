name: ðŸš€ Ignite Neural Hypernova
on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Environment (local/aws)'
        required: true
        default: 'local'

jobs:
  deploy:
    # Use 'self-hosted' for Local Demo, 'ubuntu-latest' for AWS
    runs-on: ${{ inputs.target == 'local' && 'self-hosted' || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v3

      # 1. INFRASTRUCTURE (Terraform)
      - name: ðŸ—ï¸ Provision Infrastructure
        run: |
          cd infra
          terraform init
          terraform apply -var="target=${{ inputs.target }}" -auto-approve

      # 2. CONFIGURATION (Ansible)
      # Terraform generated the inventory file in the previous step
      - name: Bootstrap ClusterðŸ (Setup & Run Ansible)
        run: |
          cd config
          
          echo ">> [INIT] Creating Virtual Environment..."
          # Create a fresh python environment
          python3 -m venv venv
          
          # Activate it
          source venv/bin/activate
          
          echo ">> [DEPENDENCY] Installing Ansible & Kubernetes Libs..."
          # Now pip installs strictly inside 'venv'
          pip install --upgrade pip
          pip install ansible kubernetes
          
          echo ">> [GALAXY] Installing K8s Collection..."
          ansible-galaxy collection install kubernetes.core
          
          echo ">> [EXECUTION] Running Playbook..."
          # Crucial: We force Ansible to use the Python inside the Venv
          ansible-playbook -i ../infra/inventory.ini playbook.yaml \
            -e "ansible_python_interpreter=$(which python)"