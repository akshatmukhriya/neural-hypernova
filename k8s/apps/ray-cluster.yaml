apiVersion: v1
kind: Service
metadata:
  name: ray-head
  namespace: default
  labels:
    ray.io/node-type: head
spec:
  ports:
  - name: redis
    port: 6379
    targetPort: 6379
  - name: dashboard
    port: 8265
    targetPort: 8265
  - name: client
    port: 10001
    targetPort: 10001
  selector:
    ray.io/node-type: head
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ray-head
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      ray.io/node-type: head
  template:
    metadata:
      labels:
        ray.io/node-type: head
    spec:
      containers:
      - name: ray-head
        image: rayproject/ray:2.9.0
        command: [ "/bin/bash", "-c", "--" ]
        args:
          # Cap object store at 1GB, disable usage stats to save network/cpu
          - "ray start --head --dashboard-host=0.0.0.0 --port=6379 --object-store-memory=1073741824 --disable-usage-stats --block" 
        volumeMounts:
        - mountPath: /dev/shm
          name: dshm     
        resources:
          requests:
            cpu: "1"
            memory: "4Gi"   # Give it MAXIMUM power
          limits:       
            cpu: "1"
            memory: "4Gi"
        ports:
        - containerPort: 8265
        - containerPort: 6379
        # ADDED PROBE: Don't kill it if it's slow to start
        livenessProbe:
          tcpSocket:
            port: 8265
          initialDelaySeconds: 30
          periodSeconds: 10
      volumes:
      - name: dshm
        emptyDir:
          medium: Memory
---
# WORKERS DISABLED FOR STABILITY TEST
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ray-worker
  namespace: default
spec:
  replicas: 0  
  selector:
    matchLabels:
      ray.io/node-type: worker
  template:
    metadata:
      labels:
        ray.io/node-type: worker
    spec:
      containers:
      - name: ray-worker
        image: rayproject/ray:2.9.0
        command: [ "/bin/bash", "-c", "--" ]
        args:
          - "ray start --address=ray-head:6379 --object-store-memory=536870912 --block"
        resources:
          requests:
            cpu: "500m"
            memory: "1Gi"
        volumeMounts:
        - mountPath: /dev/shm
          name: dshm
      volumes:
      - name: dshm
        emptyDir:
          medium: Memory