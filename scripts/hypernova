#!/bin/bash
set -e

# Path to Terraform directory
TF_DIR="infra/terraform"

function ignite() {
    echo "[HYPERNOVA] Initiating Infrastructure..."
    
    # 1. Terraform Deployment
    cd $TF_DIR
    terraform init
    terraform apply -auto-approve
    
    # 2. Extract Cluster Name from Terraform Output (The Pro way)
    # This prevents the "ResourceNotFound" error
    CLUSTER_NAME=$(terraform output -raw cluster_name)
    REGION=$(terraform output -raw region)
    
    echo "[HYPERNOVA] Syncing Kubeconfig for $CLUSTER_NAME..."
    aws eks update-kubeconfig --region $REGION --name $CLUSTER_NAME
    
    # 3. Add Helm Repos
    helm repo add cilium https://helm.cilium.io/
    helm repo add karpenter https://charts.karpenter.sh/
    helm repo update

    # 4. Deploy High-Performance Core
    echo "[HYPERNOVA] Injecting eBPF Data Plane & Karpenter..."
    # (Rest of your helm install commands here...)
    
    echo "[HYPERNOVA] CLUSTER ONLINE."
}

function nuke() {
    echo "[HYPERNOVA] SCORCHED EARTH PROTOCOL..."
    # Same as before, but navigate to $TF_DIR first
    cd $TF_DIR
    terraform destroy -auto-approve
}

case "$1" in
    ignite) ignite ;;
    nuke) nuke ;;
esac