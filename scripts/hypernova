#!/bin/bash
set -e

# Path to Terraform directory
TF_DIR="infra/terraform"

function ignite() {
    log "Initiating Infrastructure Provisioning..."
    cd infra/terraform
    terraform init
    terraform apply -auto-approve

    log "Extracting Architectural Metadata..."
    # The '|| echo "neural-hypernova"' is a safety fallback
    CLUSTER_NAME=$(terraform output -raw cluster_name 2>/dev/null || echo "neural-hypernova")
    REGION=$(terraform output -raw region 2>/dev/null || echo "us-east-1")

    log "Syncing Kubeconfig for Cluster: $CLUSTER_NAME in $REGION..."
    aws eks update-kubeconfig --region "$REGION" --name "$CLUSTER_NAME"

    # Verify connection
    kubectl get nodes

    log "Injecting High-Performance Components..."
    # Helm commands follow...
    helm repo add cilium https://helm.cilium.io/
    helm repo add karpenter https://charts.karpenter.sh/
    helm repo update

    # Optimized Cilium Install for AI (Bypassing Kube-Proxy)
    helm upgrade --install cilium cilium/cilium --version 1.15.5 \
      --namespace kube-system \
      --set kubeProxyReplacement=true \
      --set k8sServiceHost=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}') \
      --set k8sServicePort=6443

    log "HYPERNOVA CLUSTER IS ARMED."
}

case "$1" in
    ignite) ignite ;;
    nuke) nuke ;;
esac