#!/bin/bash
set -e

# --- ANCHOR THE PATHS ---
# This finds the root of your repo regardless of where you run the script
ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)
TF_DIR="$ROOT_DIR/infra/terraform"
K8S_DIR="$ROOT_DIR/k8s"

COLOR_CYAN='\033[0;36m'
COLOR_GREEN='\033[0;32m'
COLOR_RESET='\033[0m'

function log() { echo -e "${COLOR_CYAN}[HYPERNOVA-LOG] $1${COLOR_RESET}"; }

function ignite() {
    log "ðŸš€ Ignite Sequence Started..."

    # 1. Terraform Deployment
    cd "$TF_DIR"
    log "Applying Infrastructure at $TF_DIR..."
    terraform init -reconfigure
    terraform apply -auto-approve

    # 2. Extract Metadata
    CLUSTER_NAME=$(terraform output -raw cluster_name)
    REGION=$(terraform output -raw region)
    log "Metadata Extracted: Cluster=$CLUSTER_NAME, Region=$REGION"

    # 3. Kubeconfig Sync
    aws eks update-kubeconfig --region "$REGION" --name "$CLUSTER_NAME"

    # 4. Helm & K8s Injection
    log "Registering Repos..."
    helm repo add cilium https://helm.cilium.io/
    helm repo add karpenter https://charts.karpenter.sh/
    helm repo add kuberay https://ray-project.github.io/kuberay-helm/
    helm repo update

    log "Injecting Cilium (eBPF Data Plane)..."
    helm upgrade --install cilium cilium/cilium --version 1.16.1 \
      --namespace kube-system \
      --set kubeProxyReplacement=true \
      --wait || true # Don't let cilium restart timeout kill the script

    log "Injecting Karpenter (The Scaler)..."
    helm upgrade --install karpenter oci://public.ecr.aws/karpenter/karpenter \
      --version v0.35.0 \
      --namespace karpenter --create-namespace \
      --set settings.aws.clusterName="$CLUSTER_NAME" \
      --set settings.aws.defaultInstanceProfile="KarpenterNodeInstanceProfile-$CLUSTER_NAME"

    log "Deploying KubeRay Operator..."
    helm upgrade --install kuberay-operator kuberay/kuberay-operator --version 1.0.0

    # 5. Apply Workloads (Using Absolute Paths)
    log "Applying GPU Forge Manifests..."
    kubectl apply -f "$K8S_DIR/core/karpenter-gpu-pool.yaml"
    kubectl apply -f "$K8S_DIR/ai-forge/ray-cluster.yaml"

    log "âœ… NEURAL HYPERNOVA IS LIVE."
}

function nuke() {
    log "â˜¢ï¸ Scorched Earth Protocol..."
    cd "$TF_DIR"
    # Try to get metadata for CLI cleanup before destroying TF
    CLUSTER_NAME=$(terraform output -raw cluster_name 2>/dev/null || echo "neural-hypernova")
    
    # 1. Delete K8s Resources
    kubectl delete -f "$K8S_DIR/ai-forge/ray-cluster.yaml" --ignore-not-found || true
    
    # 2. Terraform Destroy
    terraform destroy -auto-approve || true
    
    # 3. CLI Clean up for orphaned ENIs
    log "Final Sweep of Security Groups..."
    SGS=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=*$CLUSTER_NAME*" --query "SecurityGroups[*].GroupId" --output text)
    for sg in $SGS; do
        aws ec2 delete-security-group --group-id $sg || true
    done
    log "ðŸŒ‘ ZERO TRACE."
}

case "$1" in
    ignite) ignite ;;
    nuke) nuke ;;
esac