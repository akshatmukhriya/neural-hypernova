---
- name: ðŸš€ Bootstrap Neural Hypernova
  hosts: supernova  
  gather_facts: false
  vars:
    # Force Ansible to use the Venv Python (Hermetic Environment)
    ansible_python_interpreter: "{{ ansible_playbook_python }}"

  tasks:
    # 1. CREATE NAMESPACE (The Room)
    - name: Ensure ArgoCD Namespace Exists
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        name: argocd
        api_version: v1
        kind: Namespace
        state: present

    # 2. INSTALL ARGOCD (The Engine)
    - name: Install ArgoCD (Lite Edition) via Kustomize
      ansible.builtin.shell:
        cmd: "kubectl apply -k . --kubeconfig '{{ kubeconfig_path }}'"
        chdir: "{{ playbook_dir }}/argocd-lite"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"


    # 3. WAIT FOR ARGOCD (The Pulse Check)
    - name: Wait for ArgoCD Server to be Ready
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig_path }}"
        kind: Deployment
        namespace: argocd
        name: argocd-server
      register: argocd_status
      # Logic: Wait until we have at least 1 healthy replica
      until: (argocd_status.resources[0].status.availableReplicas | default(0)) > 0
      retries: 20
      delay: 15

    # 4. DEPLOY THE BRAIN (App of Apps)
    - name: Apply "App of Apps" (Kickstart GitOps)
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        definition:
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: root-app
            namespace: argocd
          spec:
            project: default
            source:
              repoURL: 'https://github.com/akshatmukhriya/neural-hypernova'
              targetRevision: HEAD
              path: k8s
            destination:
              server: 'https://kubernetes.default.svc'
              namespace: default
            syncPolicy:
              automated:
                prune: true
                selfHeal: true