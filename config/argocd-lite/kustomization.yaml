apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: argocd

# 1. Base (The Heavy Upstream)
resources:
  - https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# 2. Scale Down Bloat
replicas:
- name: argocd-notifications-controller
  count: 0
- name: argocd-applicationset-controller
  count: 0
- name: argocd-dex-server
  count: 1

# 3. The Surgery (Strategic Merge - The Safe Way)
patches:
  # A. ARGOCD SERVER (UI)
  - target:
      kind: Deployment
      name: argocd-server
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: argocd-server
      spec:
        template:
          spec:
            containers:
            - name: argocd-server
              livenessProbe: null
              readinessProbe: null
              resources:
                requests:
                  cpu: "50m"
                  memory: "64Mi"
                limits: null

  # B. REPO SERVER
  - target:
      kind: Deployment
      name: argocd-repo-server
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: argocd-repo-server
      spec:
        template:
          spec:
            containers:
            - name: argocd-repo-server
              livenessProbe: null
              readinessProbe: null
              resources:
                requests:
                  cpu: "50m"
                  memory: "64Mi"
                limits: null

  # C. APPLICATION CONTROLLER
  - target:
      kind: StatefulSet
      name: argocd-application-controller
    patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: argocd-application-controller
      spec:
        template:
          spec:
            containers:
            - name: argocd-application-controller
              livenessProbe: null
              readinessProbe: null
              resources:
                requests:
                  cpu: "50m"
                  memory: "64Mi"
                limits: null

  # D. REDIS (Fix Name & Resources)
  - target:
      kind: Deployment
      name: argocd-redis
    patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: argocd-redis
      spec:
        template:
          spec:
            containers:
            - name: redis
              resources:
                requests:
                  cpu: "50m"
                  memory: "64Mi"
                limits: null